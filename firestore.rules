'rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {

      // ====================================================================
      // YENİ SİSTEM İÇİN EKLENEN/GÜNCELLENEN KURALLAR
      // ====================================================================

      // YENİ: Birleşik profil sistemi (personal + business)
      // Herkes profilleri okuyabilir, sadece sahibi yazabilir.
      match /profiles/{profileId} {
        allow read: if true;
        allow write: if request.auth != null && (request.auth.uid == resource.data.ownerUid || request.auth.uid == resource.data.uid);
      }

      // GÜNCELLENDİ: Birleşik mesajlaşma sistemi (anonim + normal)
      // Kullanıcılar sadece kendilerine gelen mesajları okuyabilir.
      // Sadece giriş yapmış kullanıcılar mesaj oluşturabilir.
      match /messages/{messageId} {
        allow read: if request.auth != null && request.auth.uid == resource.data.recipientUid;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.recipientUid;
      }

      // YENİ: Tek kullanımlık QR token'ları
      // Güvenlik için istemciden okunamaz/güncellenemez. Sadece sunucu erişir.
      match /qrTokens/{tokenId} {
        allow read, update, delete: if false;
        allow create: if request.auth != null;
      }

      // ====================================================================
      // MEVCUT SİSTEMİNİZ İÇİN KORUNAN ESKİ KURALLAR
      // ====================================================================

      // Eski 'users' koleksiyonu
      match /users/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow read: if request.auth != null &&
                       resource.data.get('isPublic', false) == true;
      }

      // Eski 'businesses' koleksiyonu
      match /businesses/{businessId} {
        allow read, write: if request.auth != null && request.auth.uid == businessId;
        allow read: if true;
      }

      // 'stats' koleksiyonu (Güvenlik notu: Bu kural canlıya geçmeden sıkılaştırılmalı)
      match /stats/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow update: if request.auth != null &&
                         request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['views', 'scans', 'clicks', 'lastUpdated']);
        allow create: if request.auth != null &&
                         request.resource.data.keys().hasAll(['userId', 'scans', 'views', 'clicks']);
      }

      // Eski 'qrcodes' koleksiyonu
      match /qrcodes/{qrId} {
        allow read, write: if request.auth != null &&
                              request.auth.uid == resource.data.get('userId', '');
        allow read: if request.auth != null &&
                       resource.data.get('isPublic', false) == true;
      }

      // 'qr_modes' koleksiyonu
      match /qr_modes/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null &&
                        request.auth.uid == userId &&
                        request.resource.data.keys().hasAll(['mode', 'content', 'userId']) &&
                        request.resource.data.mode in ['profile', 'note', 'song'];
      }

      // Eski 'anonymous_messages' koleksiyonu (Yeni 'messages' kuralı bunun yerini alıyor)
      // Ama olası bir çakışmayı önlemek için kuralı burada tutuyoruz.
      match /anonymous_messages/{messageId} {
        allow create: if request.auth != null &&
                         request.resource.data.keys().hasAll(['to', 'text', 'timestamp', 'anonymous']);
        allow read: if request.auth != null &&
                       request.auth.uid == resource.data.to;
        allow update, delete: if false;
      }

      // Diğer mevcut kurallarınız
      match /uploads/{userId}/{fileName} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /user-mockups/{userId}/{fileName} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /user-exports/{userId}/{fileName} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /public/{document=**} {
        allow read: if true;
        allow write: if false;
      }

      // Varsayılan olarak her şeyi reddet kuralı (ÇOK ÖNEMLİ)
      // Bu kural her zaman en sonda olmalı.
      match /{document=**} {
        allow read, write: if false;
      }
    }
  }
